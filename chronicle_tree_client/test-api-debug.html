<!DOCTYPE html>
<html>
<head>
    <title>Relationship Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .output { background: #f5f5f5; padding: 10px; margin: 10px 0; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>Relationship Calculator Debug Test</h1>
    <div id="output"></div>
    <button onclick="testAPI()">Test API Data</button>
    <button onclick="testRelationshipCalculation()">Test Relationship Calculation</button>
    
    <script>
        const outputDiv = document.getElementById('output');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `output ${type}`;
            div.innerHTML = message;
            outputDiv.appendChild(div);
            console.log(message);
        }
        
        async function testAPI() {
            try {
                log('Fetching data from API...', 'info');
                
                // Test the full tree API endpoint
                const response = await fetch('http://localhost:3000/api/v1/people/tree', {
                    headers: {
                        'Content-Type': 'application/json',
                        // You might need to add authentication headers here
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log(`✅ API Response received. Nodes: ${data.nodes.length}, Edges: ${data.edges.length}`, 'success');
                
                // Find Charlie and David in the data
                const charlie = data.nodes.find(n => n.id === 5 || n.first_name === 'Charlie');
                const david = data.nodes.find(n => n.id === 4 || n.first_name === 'David');
                
                if (charlie && david) {
                    log(`Found Charlie: ${JSON.stringify(charlie)}`, 'info');
                    log(`Found David: ${JSON.stringify(david)}`, 'info');
                    
                    // Find edges involving Charlie (5) or David (4)
                    const relevantEdges = data.edges.filter(edge => 
                        edge.from === 5 || edge.to === 5 || edge.from === 4 || edge.to === 4 ||
                        edge.from === '5' || edge.to === '5' || edge.from === '4' || edge.to === '4'
                    );
                    
                    log(`Relevant edges for Charlie/David: ${JSON.stringify(relevantEdges, null, 2)}`, 'info');
                    
                    // Store data globally for relationship testing
                    window.apiData = data;
                    
                } else {
                    log('❌ Could not find Charlie or David in the API data', 'error');
                }
                
            } catch (error) {
                log(`❌ Error fetching API data: ${error.message}`, 'error');
                console.error('API Error:', error);
            }
        }
        
        function testRelationshipCalculation() {
            if (!window.apiData) {
                log('❌ No API data available. Please test API first.', 'error');
                return;
            }
            
            log('Testing relationship calculation with API data...', 'info');
            
            // This would require importing the relationship calculator
            // For now, just log the data structure
            const charlie = window.apiData.nodes.find(n => n.id === 5 || n.first_name === 'Charlie');
            const david = window.apiData.nodes.find(n => n.id === 4 || n.first_name === 'David');
            
            if (charlie && david) {
                log('Would calculate: David → Charlie relationship', 'info');
                log(`Using nodes: ${window.apiData.nodes.length} people`, 'info');
                log(`Using edges: ${window.apiData.edges.length} relationships`, 'info');
                
                // Manual analysis of the data
                const charlieEdges = window.apiData.edges.filter(edge => 
                    edge.from === charlie.id || edge.to === charlie.id
                );
                const davidEdges = window.apiData.edges.filter(edge => 
                    edge.from === david.id || edge.to === david.id
                );
                
                log(`Charlie's relationships: ${JSON.stringify(charlieEdges, null, 2)}`, 'info');
                log(`David's relationships: ${JSON.stringify(davidEdges, null, 2)}`, 'info');
                
                // Check for co-parent-in-law scenario
                const charlieChildren = charlieEdges.filter(edge => 
                    edge.type === 'parent' && edge.from === charlie.id
                ).map(edge => edge.to);
                
                const davidChildren = davidEdges.filter(edge => 
                    edge.type === 'parent' && edge.from === david.id
                ).map(edge => edge.to);
                
                log(`Charlie's children: [${charlieChildren.join(', ')}]`, 'info');
                log(`David's children: [${davidChildren.join(', ')}]`, 'info');
                
                if (charlieChildren.length === 0) {
                    log('✅ Charlie has no children - co-parent-in-law should NOT apply', 'success');
                } else {
                    log(`❌ Charlie has children: ${charlieChildren.join(', ')} - investigating...`, 'error');
                }
            }
        }
        
        // Auto-test API on page load
        window.addEventListener('load', () => {
            setTimeout(testAPI, 1000);
        });
    </script>
</body>
</html>
