<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Tree - ChronicleTree</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'app-bg': '#F8F4F0',
                        'app-container': '#FEFEFA',
                        'app-primary': '#4A4A4A',
                        'app-secondary': '#A0AEC0',
                        'app-accent': '#A0C49D',
                        'button-primary': '#4F868E',
                        'button-primary-hover': '#64A3AC',
                        'button-danger': '#e53e3e',
                        'button-danger-hover': '#c53030',
                        'link': '#4F868E',
                        'link-hover': '#64A3AC',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        #tree-viewport {
            width: 100%;
            height: calc(100vh - 200px);
            overflow: auto;
            position: relative;
            background-color: #FEFEFA;
            background-image: linear-gradient(rgba(0, 0, 0, 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 0, 0, 0.05) 1px, transparent 1px);
            background-size: 25px 25px;
            cursor: grab;
        }
        #tree-canvas {
            position: relative;
            padding: 5rem;
            transform-origin: 0 0;
            min-width: 100vw;
            min-height: 80vh;
        }
        .tree-node {
            position: absolute;
            width: 150px;
            padding: 1rem;
            background-color: #FEFEFA;
            border: 1px solid #cbd5e0;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .tree-node:hover {
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .tree-node.selected {
            border-color: #4F868E;
            box-shadow: 0 0 0 3px rgba(79, 134, 142, 0.5);
            background-color: #edf8f5;
        }
        .tree-avatar {
            width: 60px; height: 60px;
            border-radius: 50%; margin: 0 auto 0.5rem;
            border: 3px solid white;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
            object-fit: cover;
        }
        #svg-container {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        #tree-scale-controls {
            position: absolute;
            top: 20px;
            right: 24px;
            z-index: 100;
            background: rgba(255,255,255,0.92);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            display: flex;
            align-items: center;
            padding: 0.5em 1em;
        }
        #tree-scale-controls button {
            background-color: #e2e8f0;
            border: none;
            width: 2.2em;
            height: 2.2em;
            border-radius: 50%;
            margin: 0 0.15em;
            font-size: 1.25em;
            font-weight: bold;
            color: #4A4A4A;
            cursor: pointer;
            transition: background 0.16s, color 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #tree-scale-controls button:hover {
            background-color: #c3e3e7;
            color: #4F868E;
        }
        #tree-scale-label {
            min-width: 2.5em;
            text-align: center;
            font-size: 0.95em;
            color: #667;
            font-weight: 600;
        }
        .modal {
            position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0, 0, 0, 0.6);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.is-open { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: #FEFEFA; padding: 2rem; border-radius: 0.5rem;
            width: 90%; max-width: 500px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal.is-open .modal-content { transform: scale(1); }
        .toast {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%); padding: 12px 24px;
            border-radius: 6px; color: white; font-weight: 600;
            z-index: 2000; opacity: 0; transition: opacity 0.3s, transform 0.3s;
        }
        .toast.show { opacity: 1; transform: translate(-50%, -20px); }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .toast.info { background-color: #17a2b8; }

        .person-card-extended {
            position: absolute;
            left: 180px;
            top: 50%;
            transform: translateY(-50%);
            background: #FEFEFA;
            border-radius: 0.75rem;
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            min-width: 260px;
            max-width: 320px;
            z-index: 1100;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 1.5rem 1.75rem;
            border: 1.5px solid #cbd5e0;
            animation: fadeInCard 0.18s cubic-bezier(.22,1,.36,1) both;
        }
        @keyframes fadeInCard {
            from { opacity: 0; transform: translateY(-48%) scale(0.95); }
            to   { opacity: 1; transform: translateY(-50%) scale(1); }
        }
        .person-card-extended .avatar {
            width: 52px; height: 52px; border-radius: 50%; object-fit: cover; margin-right: 1rem; border: 3px solid #fff; box-shadow: 0 0 6px rgba(0,0,0,0.10);
        }
        .person-card-extended .header-row {
            display: flex; align-items: center; margin-bottom: 0.6rem;
        }
        .person-card-extended .info {
            flex: 1;
        }
        .person-card-extended .fullname {
            font-size: 1.18rem; font-weight: bold; color: #4A4A4A;
        }
        .person-card-extended .age-row {
            font-size: 1rem; color: #A0AEC0; margin-bottom: 0.1rem; display: flex; align-items: center;
        }
        .person-card-extended .age-row .gender-icon {
            margin-left: 0.3em;
        }
        .person-card-extended .btn {
            display: block; width: 100%; text-align: left; border-radius: 0.4rem; font-weight: 500; font-size: 1rem; padding: 0.6em 0.9em; margin-bottom: 0.35em;
            border: none; outline: none; transition: background 0.12s;
        }
        .person-card-extended .btn.view {
            background: #edf8f5; color: #4F868E;
        }
        .person-card-extended .btn.view:hover {
            background: #e0f3ec;
        }
        .person-card-extended .btn.edit {
            background: #f3f5f8; color: #474747;
        }
        .person-card-extended .btn.edit:hover {
            background: #e5e7eb;
        }
        .person-card-extended .btn.delete {
            background: #fff5f5; color: #e53e3e;
        }
        .person-card-extended .btn.delete:hover {
            background: #ffeaea;
        }
        .person-card-extended .close-btn {
            position: absolute; top: 15px; right: 15px; background: transparent; border: none; color: #aaa; font-size: 1.5rem; cursor: pointer; transition: color 0.18s;
        }
        .person-card-extended .close-btn:hover {
            color: #e53e3e;
        }

        /* Additional styles for mobile responsiveness */
        @media (max-width: 768px) {
            .person-card-extended {
                max-width: calc(100% - 20px); /* Ensure it doesn't overflow the canvas */
                left: 10px; /* Add some padding from the left */
                top: 10px; /* Add some padding from the top */
            }
            .tree-node {
                width: 120px;
                padding: 0.5rem;
            }
            .tree-avatar {
                width: 48px;
                height: 48px;
            }
            .tree-node .font-semibold {
                font-size: 0.8rem;
            }
            .tree-node button {
                padding: 2px 6px;
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body class="bg-app-bg text-app-primary">

    <header class="bg-app-container shadow-md flex items-center justify-between px-6 py-4 sticky top-0 z-50">
        <a href="chronicle_main_family_tree_centerable.html" class="text-2xl font-bold text-app-primary">ChronicleTree</a>
        <nav class="hidden md:flex items-center space-x-6">
            <a href="chronicle_main_family_tree_centerable.html" class="text-link font-bold border-b-2 border-link pb-1">Tree</a>
            <a href="chronicle_individual_profile.html" class="text-app-primary hover:text-link-hover font-medium transition-colors">Profile</a>
            <a href="chronicle_account_settings.html" class="text-app-primary hover:text-link-hover font-medium transition-colors">Settings</a>
        </nav>
        <div class="flex items-center space-x-5">
             <button onclick="openModal('shareTreeModal')" class="text-app-secondary hover:text-link-hover transition-colors" title="Share Tree">
                <i class="fas fa-share-alt fa-lg"></i>
            </button>
            <button id="logoutBtn" class="text-app-secondary hover:text-button-danger transition-colors" title="Logout">
                <i class="fas fa-sign-out-alt fa-lg"></i>
            </button>
            <!-- Hamburger Menu Button -->
            <button id="mobileMenuBtn" class="md:hidden text-app-primary hover:text-link-hover transition-colors" title="Menu">
                <i class="fas fa-bars fa-lg"></i>
            </button>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="hidden md:hidden bg-app-container shadow-lg">
        <nav class="flex flex-col p-4 space-y-3">
            <a href="chronicle_main_family_tree_centerable.html" class="text-link font-semibold p-2 rounded-md hover:bg-gray-100">Tree</a>
            <a href="chronicle_individual_profile.html" class="text-app-primary hover:text-link-hover p-2 rounded-md hover:bg-gray-100">Profile</a>
            <a href="chronicle_account_settings.html" class="text-app-primary hover:text-link-hover p-2 rounded-md hover:bg-gray-100">Settings</a>
        </nav>
    </div>

    <main class="p-6">
        <div class="flex justify-center mb-6">
            <button class="bg-button-primary hover:bg-button-primary-hover text-white font-semibold py-2 px-6 rounded-md flex items-center shadow-lg" onclick="openModal('addPersonModal')">
                <i class="fas fa-user-plus mr-2"></i>Add New Person
            </button>
        </div>
        <div id="tree-viewport" class="rounded-lg shadow-xl border border-gray-200" style="position:relative;">
            <div id="tree-scale-controls">
                <button onclick="setScale(currentScale - 0.1)" title="Zoom Out" aria-label="Zoom Out"><i class="fas fa-minus"></i></button>
                <span id="tree-scale-label">100%</span>
                <button onclick="setScale(currentScale + 0.1)" title="Zoom In" aria-label="Zoom In"><i class="fas fa-plus"></i></button>
            </div>
            <div id="tree-canvas">
                <svg id="svg-container"></svg>
            </div>
        </div>
    </main>
    
    <!-- Person Card (Extended Popup) -->
    <div id="personCard" style="display:none;"></div>

    <!-- Add/Edit Person Modal -->
    <div id="addPersonModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle" class="text-xl font-semibold mb-4">Add New Person</h3>
            <input type="hidden" id="personId">
            <div class="space-y-4">
                <input type="text" id="personName" class="w-full p-2 border rounded" placeholder="Full Name">
                <select id="personGender" class="w-full p-2 border rounded">
                    <option value="">Select Gender</option>
                    <option value="Female">Female</option>
                    <option value="Male">Male</option>
                </select>
                 <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-sm">Date of Birth</label><input type="date" id="personDob" class="w-full p-2 border rounded mt-1"></div>
                    <div><label class="text-sm">Date of Death</label><input type="date" id="personDod" class="w-full p-2 border rounded mt-1"></div>
                </div>
                <div class="flex items-center"><input type="checkbox" id="personIsDeceased" class="h-4 w-4 rounded mr-2"><label for="personIsDeceased">Deceased</label></div>
                <select id="personRelationType" class="w-full p-2 border rounded">
                    <option value="">Relationship Type</option>
                    <option value="parent">Parent</option>
                    <option value="child">Child</option>
                    <option value="spouse">Spouse</option>
                </select>
                <select id="personRelationTo" class="w-full p-2 border rounded"></select>
            </div>
            <div class="flex justify-end space-x-2 mt-6">
                <button class="bg-gray-300 font-semibold py-2 px-4 rounded-md" onclick="closeModal('addPersonModal')">Cancel</button>
                <button class="bg-button-primary text-white font-semibold py-2 px-4 rounded-md" onclick="savePerson()">Save Person</button>
            </div>
        </div>
    </div>

    <!-- Share Tree Modal -->
    <div id="shareTreeModal" class="modal">
        <div class="modal-content">
             <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Share Your Family Tree</h3>
            <button class="text-gray-400 hover:text-red-500 text-2xl" onclick="closeModal('shareTreeModal')" aria-label="Close modal">&times;</button>
         </div>
         <div class="bg-gray-100 p-4 rounded-lg text-center mb-4">
            <i class="fas fa-sitemap text-6xl text-gray-300"></i>
            <p class="mt-2 font-semibold">Snapshot of Your Tree</p>
         </div>
         <textarea id="shareTreeCaption" class="w-full p-2 border rounded-md" placeholder="Add an optional caption..."></textarea>
        <div class="flex justify-center space-x-4 mt-4">
            <button class="text-2xl text-blue-600 hover:text-blue-800" title="Share on Facebook" onclick="shareOnFacebook('tree')"><i class="fab fa-facebook-square"></i></button>
            <button class="text-2xl text-black hover:text-gray-700" title="Share on X" onclick="shareOnX('tree')"><i class="fab fa-x-twitter"></i></button>
            <button class="text-2xl text-green-500 hover:text-green-700" title="Share on WhatsApp" onclick="shareOnWhatsApp('tree')"><i class="fab fa-whatsapp-square"></i></button>
            <button class="text-2xl text-red-500 hover:text-red-700" title="Share via Email" onclick="shareViaEmail('tree')"><i class="fas fa-envelope-square"></i></button>
            <button class="text-2xl text-gray-600 hover:text-gray-800" onclick="copyShareLink()" title="Copy Link"><i class="fas fa-link"></i></button>
        </div>
    </div>
    </div>
    <div id="toastContainer"></div>
    <script>
    // --- Scaling ---
    let currentScale = 1.0;
    function setScale(scale) {
        currentScale = Math.max(0.3, Math.min(2.5, scale));
        document.getElementById('tree-canvas').style.transform = `scale(${currentScale})`;
        renderScaleControls();
    }
    function renderScaleControls() {
        document.getElementById('tree-scale-label').textContent = Math.round(currentScale * 100) + '%';
    }

    // --- Family Data (node-based, no manual x/y) ---
    let familyData = [
        // Generation 0 (You)
        { id: 1, name: "Yuliia S. (You)", gender: "Female", dob: "1990-05-15", dod: null, isDeceased: false, profilePic: 'https://randomuser.me/api/portraits/women/44.jpg', parents: [4,5], spouses: [2], children: [3] },
        
        // Your Spouse
        { id: 2, name: "John Doe", gender: "Male", dob: "1988-08-20", dod: null, isDeceased: false, profilePic: 'https://randomuser.me/api/portraits/men/45.jpg', parents: [13, 14], spouses: [1], children: [3] },
        
        // Your Child
        { id: 3, name: "Jane Doe", gender: "Female", dob: "2020-01-10", dod: null, isDeceased: false, profilePic: 'https://randomuser.me/api/portraits/women/1.jpg', parents: [1, 2], spouses: [], children: [] },

        // Generation +1 (Parents)
        { id: 4, name: "Vira Smyshliakova", gender: "Female", dob: "1965-01-01", dod: null, isDeceased: false, profilePic: 'https://randomuser.me/api/portraits/women/65.jpg', parents: [6, 7], spouses: [5], children: [1, 10] },
        { id: 5, name: "Anatoliy S.", gender: "Male", dob: "1963-03-12", dod: "2015-06-10", isDeceased: true, profilePic: 'https://randomuser.me/api/portraits/men/65.jpg', parents: [8, 9], spouses: [4], children: [1, 10] },

        // Generation +2 (Grandparents)
        { id: 6, name: "Anna K.", gender: "Female", dob: "1940-02-20", dod: "2018-11-15", isDeceased: true, profilePic: 'https://randomuser.me/api/portraits/women/85.jpg', parents: [], spouses: [7], children: [4] },
        { id: 7, name: "Ivan K.", gender: "Male", dob: "1938-07-10", dod: "2010-01-05", isDeceased: true, profilePic: 'https://randomuser.me/api/portraits/men/85.jpg', parents: [], spouses: [6], children: [4] },
        { id: 8, name: "Olga S.", gender: "Female", dob: "1942-09-05", dod: null, isDeceased: false, profilePic: 'https://randomuser.me/api/portraits/women/86.jpg', parents: [], spouses: [9], children: [5] },
        { id: 9, name: "Mykhailo S.", gender: "Male", dob: "1940-11-22", dod: "2005-03-30", isDeceased: true, profilePic: 'https://randomuser.me/api/portraits/men/86.jpg', parents: [], spouses: [8], children: [5] },

        // Your Sibling & Family
        { id: 10, name: "Alex S.", gender: "Male", dob: "1992-11-30", dod: null, isDeceased: false, profilePic: 'https://randomuser.me/api/portraits/men/46.jpg', parents: [4, 5], spouses: [11], children: [12] },
        { id: 11, name: "Maria S.", gender: "Female", dob: "1993-04-15", dod: null, isDeceased: false, profilePic: 'https://randomuser.me/api/portraits/women/47.jpg', parents: [], spouses: [10], children: [12] },
        { id: 12, name: "Leo S.", gender: "Male", dob: "2022-07-21", dod: null, isDeceased: false, profilePic: 'https://randomuser.me/api/portraits/men/2.jpg', parents: [10, 11], spouses: [], children: [] },

        // Spouse's Parents
        { id: 13, name: "Susan Doe", gender: "Female", dob: "1960-05-25", dod: null, isDeceased: false, profilePic: 'https://randomuser.me/api/portraits/women/66.jpg', parents: [], spouses: [14], children: [2] },
        { id: 14, name: "Robert Doe", gender: "Male", dob: "1958-10-17", dod: null, isDeceased: false, profilePic: 'https://randomuser.me/api/portraits/men/67.jpg', parents: [], spouses: [13], children: [2] }
    ];

    function getPerson(id) { return familyData.find(p => p.id == id); }

    // --- Tree Centering State ---
    let centeredPersonId = 1; // Default: the main user

    // --- Utility: BFS Ancestors/Descendants, Siblings, Spouses ---
    function collectFamilySubtree(centerId, maxUp=3, maxDown=3) {
        // Updated: Collect each relation type into its own array for layout
        const center = getPerson(centerId);
        if (!center) return { ancestors: [], siblings: [], spouses: [], self: [], children: [] };
        let seen = new Set([centerId]);
        let ancestors = [], children = [], siblings = [], spouses = [], self = [center];

        // Collect ancestors up to maxUp generations (BFS)
        let upGen = [{ p: center, level: 0 }];
        for (let g = 1; g <= maxUp; g++) {
            let nextGen = [];
            for (let { p } of upGen) {
                (p.parents || []).forEach(pid => {
                    if (!seen.has(pid)) {
                        const parent = getPerson(pid);
                        if (parent) {
                            ancestors.push(parent);
                            nextGen.push({ p: parent, level: g });
                            seen.add(pid);
                        }
                    }
                });
            }
            upGen = nextGen;
        }
        // Collect children down to maxDown generations (BFS)
        let downGen = [{ p: center, level: 0 }];
        for (let g = 1; g <= maxDown; g++) {
            let nextGen = [];
            for (let { p } of downGen) {
                (p.children || []).forEach(cid => {
                    if (!seen.has(cid)) {
                        const child = getPerson(cid);
                        if (child) {
                            children.push(child);
                            nextGen.push({ p: child, level: g });
                            seen.add(cid);
                        }
                    }
                });
            }
            downGen = nextGen;
        }
        // Siblings: share at least one parent, excluding self
        if (center.parents && center.parents.length > 0) {
            center.parents.forEach(pid => {
                const parent = getPerson(pid);
                if (parent && parent.children) {
                    parent.children.forEach(cid => {
                        if (cid !== centerId && !seen.has(cid)) {
                            const sibling = getPerson(cid);
                            if (sibling) {
                                siblings.push(sibling);
                                seen.add(cid);
                            }
                        }
                    });
                }
            });
        }
        // Spouses: directly listed
        (center.spouses || []).forEach(sid => {
            if (!seen.has(sid)) {
                const spouse = getPerson(sid);
                if (spouse) {
                    spouses.push(spouse);
                    seen.add(sid);
                }
            }
        });

        // For layout, always return arrays (ancestors, siblings, spouses, self, children)
        return { ancestors, siblings, spouses, self, children };
    }

    // --- Tree Layout Algorithm (centered, vertical by relation type) ---
    function buildTreeLayout() {
        const { ancestors, siblings, spouses, self, children } = collectFamilySubtree(centeredPersonId, 3, 3);
        // Define "levels" for layout: -1 (ancestors), -0.5 (siblings), 0 (center), 0.5 (spouses), 1 (children)
        // This gives a visual separation between types
        let levels = {
            '-1': ancestors,
            '-0.5': siblings,
            '0': self,
            '0.5': spouses,
            '1': children
        };
        // Assign x/y positions
        const isMobile = window.innerWidth < 768;
        const nodeW = isMobile ? 140 : 170;
        const nodeH = isMobile ? 110 : 120;
        const vGap = isMobile ? 40 : 60;
        const hGap = isMobile ? 20 : 40;
        // Compute each row's width
        let treeRows = Object.entries(levels).filter(([k, arr]) => arr.length > 0);
        let maxRowWidth = Math.max(...treeRows.map(([k, arr]) => arr.length));
        // Canvas size
        const treeWidth = maxRowWidth * nodeW + (maxRowWidth - 1) * hGap;
        const treeHeight = treeRows.length * nodeH + (treeRows.length - 1) * vGap;
        const canvas = document.getElementById('tree-canvas');
        let canvasW = 1200, canvasH = 900;
        if (canvas) {
            const rect = canvas.getBoundingClientRect();
            canvasW = Math.max(rect.width, treeWidth + 160);
            canvasH = Math.max(rect.height, treeHeight + 120);
        }
        // Center the main self node in the middle row
        const levelKeys = treeRows.map(([k]) => parseFloat(k));
        const centerLevelIdx = levelKeys.findIndex(k => k === 0);
        // Place nodes
        treeRows.forEach(([lvl, arr], rowIdx) => {
            const y = 60 + rowIdx * (nodeH + vGap);
            const totalW = arr.length * nodeW + (arr.length-1)*hGap;
            const startX = (canvasW - totalW) / 2;
            arr.forEach((p, i) => {
                p._x = startX + i * (nodeW + hGap);
                p._y = y;
            });
        });
        if (canvas) {
            canvas.style.minWidth = (treeWidth + 160) + "px";
            canvas.style.minHeight = (treeHeight + 120) + "px";
        }
        // Collect all people for rendering
        window._visibleTreePeople = [
            ...levels['-1'], ...levels['-0.5'], ...levels['0'], ...levels['0.5'], ...levels['1']
        ];
        window._visibleTreeLevels = levels;
    }

    // --- Tree Rendering ---
    function renderTree() {
        buildTreeLayout();
        const canvas = document.getElementById('tree-canvas');
        canvas.innerHTML = '<svg id="svg-container"></svg>';
        // Draw nodes
        (window._visibleTreePeople || []).forEach(person => {
            const node = document.createElement('div');
            node.className = 'tree-node';
            if (person.id === centeredPersonId) node.classList.add('selected');
            node.id = `node-${person.id}`;
            node.style.left = `${person._x}px`;
            node.style.top = `${person._y}px`;
            node.style.position = 'absolute';
            node.innerHTML = `
                <img src="${person.profilePic}" alt="${person.name}" class="tree-avatar">
                <div class="font-semibold text-sm">${person.name}</div>
                <div class="text-xs text-gray-500">${person.dob ? new Date(person.dob).getFullYear() : ""} - ${person.dod ? new Date(person.dod).getFullYear() : (person.isDeceased ? "" : "Present")}</div>
                <button class="mt-2 px-2 py-1 rounded bg-app-accent text-xs text-white hover:bg-button-primary transition" style="margin-top:0.5em" onclick="event.stopPropagation(); centerOnPerson(${person.id})" title="Center tree on this person"><i class="fas fa-bullseye"></i> Center</button>
            `;
            node.onclick = (e) => { e.stopPropagation(); showPersonCard(person.id, node); };
            canvas.appendChild(node);
        });
        setTimeout(drawLinks, 0);
        setScale(currentScale); // maintain scale after re-render
    }

    // --- Draw Links (parent-child: vertical; spouse: horizontal) ---
    function drawLinks() {
        const svg = document.getElementById('svg-container');
        svg.innerHTML = '';
        // Draw parent-child links (vertical, from parent to child)
        (window._visibleTreePeople || []).forEach(child => {
            (child.parents || []).forEach(pid => {
                const parent = (window._visibleTreePeople || []).find(p => p.id === pid);
                if (!parent) return;
                const pNode = document.getElementById(`node-${parent.id}`);
                const cNode = document.getElementById(`node-${child.id}`);
                if (pNode && cNode) {
                    const x1 = pNode.offsetLeft + pNode.offsetWidth/2;
                    const y1 = pNode.offsetTop + pNode.offsetHeight;
                    const x2 = cNode.offsetLeft + cNode.offsetWidth/2;
                    const y2 = cNode.offsetTop;
                    createLine(x1, y1, x2, y2, "#A0AEC0");
                }
            });
        });
        // Draw sibling links (optional dashed horizontal, lighter)
        const siblingsArr = window._visibleTreeLevels && window._visibleTreeLevels['-0.5'];
        if (siblingsArr && siblingsArr.length > 1) {
            for (let i = 0; i < siblingsArr.length - 1; i++) {
                const sib1 = siblingsArr[i], sib2 = siblingsArr[i+1];
                const sNode1 = document.getElementById(`node-${sib1.id}`);
                const sNode2 = document.getElementById(`node-${sib2.id}`);
                if (sNode1 && sNode2) {
                    createLine(
                        sNode1.offsetLeft + sNode1.offsetWidth,
                        sNode1.offsetTop + sNode1.offsetHeight/2,
                        sNode2.offsetLeft,
                        sNode2.offsetTop + sNode2.offsetHeight/2,
                        "#B0B0B0",
                        "4,4"
                    );
                }
            }
        }
        // Draw spouse links (horizontal, thick, green)
        const spousesArr = window._visibleTreeLevels && window._visibleTreeLevels['0.5'];
        if (spousesArr && spousesArr.length > 0) {
            const centerNode = document.getElementById(`node-${centeredPersonId}`);
            spousesArr.forEach(spouse => {
                const sNode = document.getElementById(`node-${spouse.id}`);
                if (centerNode && sNode) {
                    createLine(
                        centerNode.offsetLeft + centerNode.offsetWidth,
                        centerNode.offsetTop + centerNode.offsetHeight/2,
                        sNode.offsetLeft,
                        sNode.offsetTop + sNode.offsetHeight/2,
                        "#A0C49D",
                        ""
                    );
                }
            });
        }
        // Draw child links (vertical, from center/self to children)
        const childrenArr = window._visibleTreeLevels && window._visibleTreeLevels['1'];
        if (childrenArr && childrenArr.length > 0) {
            const centerNode = document.getElementById(`node-${centeredPersonId}`);
            childrenArr.forEach(child => {
                const cNode = document.getElementById(`node-${child.id}`);
                if (centerNode && cNode) {
                    createLine(
                        centerNode.offsetLeft + centerNode.offsetWidth/2,
                        centerNode.offsetTop + centerNode.offsetHeight,
                        cNode.offsetLeft + cNode.offsetWidth/2,
                        cNode.offsetTop,
                        "#A0AEC0"
                    );
                }
            });
        }
    }

    function createLine(x1, y1, x2, y2, color, dash) {
        const svg = document.getElementById('svg-container');
        const line = document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('x1', x1);
        line.setAttribute('y1', y1);
        line.setAttribute('x2', x2);
        line.setAttribute('y2', y2);
        line.setAttribute('stroke', color || '#A0AEC0');
        line.setAttribute('stroke-width', 2);
        if (dash) line.setAttribute('stroke-dasharray', dash);
        svg.appendChild(line);
    }

    // --- Pan by Drag ---
    function enablePan() {
        const viewport = document.getElementById('tree-viewport');
        let isDown = false, startX, startY, scrollLeft, scrollTop;
        viewport.addEventListener('mousedown', (e) => {
            isDown = true;
            viewport.classList.add('grabbing');
            startX = e.pageX - viewport.offsetLeft;
            startY = e.pageY - viewport.offsetTop;
            scrollLeft = viewport.scrollLeft;
            scrollTop = viewport.scrollTop;
            e.preventDefault();
        });
        viewport.addEventListener('mouseleave', () => { isDown = false; viewport.classList.remove('grabbing'); });
        viewport.addEventListener('mouseup', () => { isDown = false; viewport.classList.remove('grabbing'); });
        viewport.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - viewport.offsetLeft;
            const y = e.pageY - viewport.offsetTop;
            viewport.scrollLeft = scrollLeft - (x - startX);
            viewport.scrollTop = scrollTop - (y - startY);
        });
        // Mouse wheel zoom
        viewport.addEventListener('wheel', function(e){
            if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                setScale(currentScale + (e.deltaY < 0 ? 0.07 : -0.07));
            }
        }, { passive: false });
    }

    // --- Center on Person Logic ---
    function centerOnPerson(personId) {
        centeredPersonId = personId;
        renderTree();
        closePersonCard();
    }

    // --- Clean Popup Card ---
    function showPersonCard(personId, nodeEl) {
        const card = document.getElementById('personCard');
        card.innerHTML = '';
        card.style.display = 'none';
        const person = getPerson(personId);
        if (!person) return;
        document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('selected'));
        nodeEl.classList.add('selected');

        // --- Responsive Card Positioning ---
        const cardWidth = 320; // From CSS max-width
        const cardHeightEstimate = 230; // Estimated height for vertical check
        const margin = 15; // Space between node and card

        const nodeRect = nodeEl.getBoundingClientRect(); // Position relative to viewport, includes scaling

        // Determine if card should go left or right of the node
        const spaceRight = window.innerWidth - nodeRect.right;
        const spaceLeft = nodeRect.left;
        
        let cardLeft;
        // Prefer right side if there's enough space, or if right has more space than left
        if (spaceRight > cardWidth + margin || spaceRight > spaceLeft) {
            cardLeft = nodeRect.right + margin;
        } else {
            // Position on the left
            cardLeft = nodeRect.left - cardWidth - margin;
        }

        // Center vertically on the node
        let cardTop = nodeRect.top + nodeRect.height / 2;

        // Clamp to viewport to prevent overflow.
        // First, clamp left position.
        cardLeft = Math.max(margin, Math.min(cardLeft, window.innerWidth - cardWidth - margin));
        
        // The card uses `transform: translateY(-50%)`, so we adjust the top based on its estimated height
        const halfCardHeight = cardHeightEstimate / 2;
        cardTop = Math.max(halfCardHeight + margin, Math.min(cardTop, window.innerHeight - halfCardHeight - margin));

        // The card's container (#personCard) is positioned relative to the document body.
        // So we need to add the window's scroll offsets to get the final absolute position.
        const finalLeft = cardLeft + window.scrollX;
        const finalTop = cardTop + window.scrollY;

        let ageText = '';
        if (person.dob) {
            const dob = new Date(person.dob);
            if (person.isDeceased && person.dod) {
                const dod = new Date(person.dod);
                let age = dod.getFullYear() - dob.getFullYear();
                const m = dod.getMonth() - dob.getMonth();
                if (m < 0 || (m === 0 && dod.getDate() < dob.getDate())) age--;
                ageText = `${age} y.o. (deceased)`;
            } else {
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                const m = today.getMonth() - dob.getMonth();
                if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) age--;
                ageText = `${age} y.o.`;
            }
        }
        const genderIcon = person.gender === 'Female'
            ? '<i class="fas fa-venus text-pink-500 gender-icon"></i>'
            : person.gender === 'Male'
            ? '<i class="fas fa-mars text-blue-500 gender-icon"></i>'
            : '';
        card.innerHTML = `
            <div class="person-card-extended" style="left:${finalLeft}px; top:${finalTop}px; transform:translateY(-50%);">
                <button class="close-btn" onclick="closePersonCard()" title="Close">&times;</button>
                <div class="header-row">
                    <img src="${person.profilePic}" alt="${person.name}" class="avatar" />
                    <div class="info">
                        <div class="fullname">${person.name}</div>
                        <div class="age-row">${ageText} ${genderIcon}</div>
                    </div>
                </div>
                <button class="btn view" onclick="window.location.href='chronicle_individual_profile.html'">View Profile</button>
                <button class="btn edit" onclick="editPerson(${personId})">Edit Details</button>
                <button class="btn delete" onclick="deletePerson(${personId})">Delete</button>
            </div>
        `;
        card.style.position = 'absolute';
        card.style.left = '0';
        card.style.top = '0';
        card.style.width = '100%';
        card.style.height = '100%';
        card.style.pointerEvents = 'none';
        card.querySelector('.person-card-extended').style.pointerEvents = 'auto';
        card.style.display = 'block';
        setTimeout(() => {
            window.addEventListener('mousedown', personCardOutsideClick);
        }, 0);
    }
    function closePersonCard() {
        const card = document.getElementById('personCard');
        card.innerHTML = '';
        card.style.display = 'none';
        document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('selected'));
        window.removeEventListener('mousedown', personCardOutsideClick);
    }
    function personCardOutsideClick(e) {
        const card = document.querySelector('.person-card-extended');
        if (!card) return;
        if (!card.contains(e.target)) closePersonCard();
    }

    function editPerson(personId) {
        closePersonCard();
        const person = getPerson(personId);
        if (!person) return;
        document.getElementById('modalTitle').textContent = 'Edit Person Details';
        document.getElementById('personId').value = person.id;
        document.getElementById('personName').value = person.name;
        document.getElementById('personGender').value = person.gender;
        document.getElementById('personDob').value = person.dob;
        document.getElementById('personDod').value = person.dod;
        document.getElementById('personIsDeceased').checked = person.isDeceased;
        document.getElementById('personRelationType').value = '';
        document.getElementById('personRelationTo').innerHTML = '';
        openModal('addPersonModal');
    }

    function savePerson() {
        const id = parseInt(document.getElementById('personId').value);
        const name = document.getElementById('personName').value;
        const gender = document.getElementById('personGender').value;
        const dob = document.getElementById('personDob').value;
        const dod = document.getElementById('personDod').value;
        const isDeceased = document.getElementById('personIsDeceased').checked;
        const relType = document.getElementById('personRelationType').value;
        const relTo = parseInt(document.getElementById('personRelationTo').value);

        if (!name || !gender || !dob) {
            showToast('Name, gender, and date of birth are required.', 'error');
            return;
        }

        if (id) {
            // Edit
            const person = getPerson(id);
            Object.assign(person, { name, gender, dob, dod, isDeceased });
            showToast('Person details updated!', 'success');
        } else {
            // New person
            const newId = Date.now();
            const newPerson = { id: newId, name, gender, dob, dod, isDeceased, profilePic: 'https://placehold.co/100x100/F8F4F0/4A4A4A?text=?', parents: [], spouses: [], children: [] };
            // Relate if selected
            if (relType && relTo) {
                if (relType === "parent") {
                    // current is child, relTo is parent
                    newPerson.parents.push(relTo);
                    const parent = getPerson(relTo);
                    if (parent) (parent.children = parent.children || []).push(newId);
                } else if (relType === "child") {
                    // current is parent, relTo is child
                    newPerson.children.push(relTo);
                    const child = getPerson(relTo);
                    if (child) (child.parents = child.parents || []).push(newId);
                } else if (relType === "spouse") {
                    newPerson.spouses.push(relTo);
                    const spouse = getPerson(relTo);
                    if (spouse) (spouse.spouses = spouse.spouses || []).push(newId);
                }
            }
            familyData.push(newPerson);
            showToast('Person added to the tree!', 'success');
        }
        closeModal('addPersonModal');
        renderTree();
        closePersonCard();
    }
    
    function deletePerson(personId) {
        if(confirm('Are you sure you want to delete this person? This cannot be undone.')) {
            // Remove references from others
            familyData.forEach(p => {
                if (p.parents) p.parents = p.parents.filter(pid => pid !== personId);
                if (p.children) p.children = p.children.filter(cid => cid !== personId);
                if (p.spouses) p.spouses = p.spouses.filter(sid => sid !== personId);
            });
            familyData = familyData.filter(p => p.id !== personId);
            closePersonCard();
            showToast('Person deleted.', 'success');
            // If deleted person was centered, reset to first available
            if (centeredPersonId === personId) {
                centeredPersonId = familyData.length > 0 ? familyData[0].id : null;
            }
            renderTree();
        }
    }

    function populateRelationshipDropdowns() {
        const relTypeSel = document.getElementById('personRelationType');
        const relToSel = document.getElementById('personRelationTo');
        relToSel.innerHTML = '<option value="">Select Person</option>';
        relTypeSel.onchange = () => {
            const t = relTypeSel.value;
            relToSel.innerHTML = '<option value="">Select Person</option>';
            if (t) {
                familyData.forEach(p => {
                    relToSel.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                });
            }
        };
    }

    // --- Share Functionality ---
    function shareOnFacebook(type) {
        const url = window.location.href;
        const caption = document.getElementById('shareTreeCaption').value;
        const fbUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}&quote=${encodeURIComponent(caption)}`;
        window.open(fbUrl, '_blank');
    }
    function shareOnX(type) {
        const url = window.location.href;
        const caption = document.getElementById('shareTreeCaption').value;
        const xUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(caption)}`;
        window.open(xUrl, '_blank');
    }
    function shareOnWhatsApp(type) {
        const url = window.location.href;
        const caption = document.getElementById('shareTreeCaption').value;
        const waUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(caption + ' ' + url)}`;
        window.open(waUrl, '_blank');
    }
    function shareViaEmail(type) {
        const url = window.location.href;
        const caption = document.getElementById('shareTreeCaption').value;
        const emailUrl = `mailto:?subject=${encodeURIComponent('Check out my family tree')}&body=${encodeURIComponent(caption + ' ' + url)}`;
        window.location.href = emailUrl;
    }
    function copyShareLink() {
        const url = window.location.href;
        const caption = document.getElementById('shareTreeCaption').value;
        navigator.clipboard.writeText(caption + ' ' + url).then(() => {
            showToast('Link copied to clipboard!', 'success');
        }, () => {
            showToast('Failed to copy link.', 'error');
        });
    }

    // --- Modal Open/Close Logic ---
    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('is-open');
            document.body.style.overflow = 'hidden';
            if (modalId === 'addPersonModal') {
                populateRelationshipDropdowns();
            }
        }
    }
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.remove('is-open');
            document.body.style.overflow = '';
            // Reset form for add/edit person
            if (modalId === 'addPersonModal') {
                document.getElementById('personId').value = '';
                document.getElementById('personName').value = '';
                document.getElementById('personGender').value = '';
                document.getElementById('personDob').value = '';
                document.getElementById('personDod').value = '';
                document.getElementById('personIsDeceased').checked = false;
                document.getElementById('personRelationType').value = '';
                document.getElementById('personRelationTo').innerHTML = '';
            }
            // Reset share modal caption
            if (modalId === 'shareTreeModal') {
                document.getElementById('shareTreeCaption').value = '';
            }
        }
    }

    // --- Toast Notifications ---
    function showToast(message, type) {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast show ${type}`;
        toast.innerText = message;
        toastContainer.appendChild(toast);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => { toastContainer.removeChild(toast); }, 300);
        }, 3000);
    }

    // --- Initial Setup ---
    window.addEventListener('resize', () => {
        renderTree();
    });

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('logoutBtn').addEventListener('click', () => {
            showToast('Logging out...', 'info');
            setTimeout(() => window.location.href = 'chronicle_login.html', 1000);
        });

        // Mobile menu toggle
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobileMenu = document.getElementById('mobileMenu');
        if (mobileMenuBtn && mobileMenu) {
            mobileMenuBtn.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });
        }

        renderTree();
        enablePan();
        renderScaleControls();
        window.addEventListener('resize', renderTree);
    });

    // --- Add/Edit Life Milestone Sections ---
    function showAddMilestone() {
        document.getElementById('addMilestone').style.display = 'block';
        document.getElementById('editMilestone').style.display = 'none';
    }

    function showEditMilestone() {
        document.getElementById('editMilestone').style.display = 'block';
        document.getElementById('addMilestone').style.display = 'none';
    }
    </script>

    <!-- Add Life Milestone -->
    <div id="addMilestone" style="display:none;">
        <h2>Add Life Milestone</h2>
        <!-- Form elements go here -->
    </div>

    <!-- Edit Life Milestone -->
    <div id="editMilestone" style="display:none;">
        <h2>Edit Life Milestone</h2>
        <!-- Form elements go here -->
    </div>
</body>
</html>