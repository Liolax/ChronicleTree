<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Individual Profile - ChronicleTree</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Updated Font Awesome CDN to a newer version that includes the 'fa-x-twitter' icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"> 
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'app-bg': '#F8F4F0',
                        'app-container': '#FEFEFA',
                        'app-primary': '#4A4A4A',
                        'app-secondary': '#A0AEC0',
                        'app-accent': '#A0C49D',
                        'button-primary': '#4F868E',
                        'button-primary-hover': '#64A3AC',
                        'button-danger': '#e53e3e',
                        'button-danger-hover': '#c53030',
                        'link': '#4F868E',
                        'link-hover': '#64A3AC',
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal {
            position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0, 0, 0, 0.6);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.is-open { opacity: 1; visibility: visible; }
        .modal-content {
            background-color: #FEFEFA; padding: 2rem; border-radius: 0.5rem;
            width: 90%; max-width: 500px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal.is-open .modal-content { transform: scale(1); }
        .details-section .edit-mode { display: none; }
        .details-section.editing .edit-mode { display: block; }
        .details-section.editing .view-mode { display: none; }
        .toast {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%); padding: 12px 24px;
            border-radius: 6px; color: white; font-weight: 600;
            z-index: 2000; opacity: 0; transition: opacity 0.3s, transform 0.3s;
        }
        .toast.show { opacity: 1; transform: translate(-50%, -20px); }
        .toast.success { background-color: #28a745; }
        .toast.error { background-color: #dc3545; }
        .toast.info { background-color: #17a2b8; }
        /* Timeline icon picker */
        #icon-picker .icon-option { cursor: pointer; padding: 0.5rem; border-radius: 0.375rem; transition: background-color 0.2s; }
        #icon-picker .icon-option:hover { background-color: #e2e8f0; }
        #icon-picker .icon-option.selected { background-color: #A0C49D; box-shadow: 0 0 0 2px #4F868E; }
    </style>
</head>
<body class="bg-app-bg text-app-primary">

    <!-- Consistent Header -->
    <header class="bg-app-container shadow-md flex items-center justify-between px-6 py-4 sticky top-0 z-50">
        <a href="chronicle_main_family_tree.html" class="text-2xl font-bold text-app-primary">ChronicleTree</a>
        <nav class="hidden md:flex items-center space-x-6">
            <a href="chronicle_main_family_tree.html" class="text-app-primary hover:text-link-hover font-medium transition-colors">Tree</a>
            <a href="chronicle_individual_profile.html" class="text-link font-bold border-b-2 border-link pb-1">Profile</a>
            <a href="chronicle_account_settings.html" class="text-app-primary hover:text-link-hover font-medium transition-colors">Settings</a>
        </nav>
        <div class="flex items-center space-x-5">
             <button onclick="openModal('shareProfileModal')" class="text-app-secondary hover:text-link-hover transition-colors" title="Share Profile">
                <i class="fas fa-share-alt fa-lg"></i>
            </button>
            <button id="logoutBtn" class="text-app-secondary hover:text-button-danger transition-colors" title="Logout">
                <i class="fas fa-sign-out-alt fa-lg"></i>
            </button>
            <!-- Hamburger Menu Button -->
            <button id="mobileMenuBtn" class="md:hidden text-app-primary hover:text-link-hover transition-colors" title="Menu">
                <i class="fas fa-bars fa-lg"></i>
            </button>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="hidden md:hidden bg-app-container shadow-lg">
        <nav class="flex flex-col p-4 space-y-3">
            <a href="chronicle_main_family_tree.html" class="text-app-primary hover:text-link-hover p-2 rounded-md hover:bg-gray-100">Tree</a>
            <a href="chronicle_individual_profile.html" class="text-link font-semibold p-2 rounded-md hover:bg-gray-100">Profile</a>
            <a href="chronicle_account_settings.html" class="text-app-primary hover:text-link-hover p-2 rounded-md hover:bg-gray-100">Settings</a>
        </nav>
    </div>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto my-10 p-4">
        <div class="bg-app-container rounded-xl shadow-lg p-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Profile Picture and Key Facts -->
            <aside class="lg:col-span-1 flex flex-col items-center space-y-6">
                <div class="relative group">
                    <img id="profileImage" class="w-48 h-48 rounded-full object-cover shadow-lg border-4 border-white" src="https://randomuser.me/api/portraits/women/44.jpg" alt="Profile picture">
                    <button class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity" onclick="openModal('editProfilePicModal')">
                        <i class="fas fa-camera text-white text-4xl"></i>
                    </button>
                </div>
                <div class="text-center">
                     <h1 id="profileName" class="text-3xl font-bold text-app-primary">Yuliia Smyshliakova</h1>
                     <p id="profileAge" class="text-lg text-app-secondary">35 y.o. <i class="fas fa-venus text-pink-500"></i></p>
                </div>
                
                <div class="w-full bg-slate-50 rounded-lg p-4 shadow-inner">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-semibold">Key Facts</h3>
                        <button class="text-app-primary hover:text-link-hover" title="Edit Key Fact" onclick="openModal('addFactModal')"><i class="fas fa-plus-circle"></i> Add</button>
                    </div>
                    <ul id="keyFactsList" class="space-y-2 text-app-primary text-sm">
                        <!-- Key facts will be rendered here by JavaScript -->
                    </ul>
                </div>
            </aside>

            <!-- Right Column: Basic Info, Timeline, Notes, Media -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Basic Info -->
                <section id="basicInfoSection" class="details-section">
                    <div class="flex justify-between items-center pb-2 border-b mb-4">
                        <h2 class="text-2xl font-semibold">Basic Information</h2>
                        <div>
                             <button class="view-mode text-app-primary hover:text-link-hover" onclick="enterEditMode('basicInfoSection')"><i class="fas fa-pencil-alt"></i> Edit</button>
                             <div class="edit-mode space-x-2">
                                <button class="bg-button-primary hover:bg-button-primary-hover text-white font-semibold py-1 px-3 rounded-md transition-colors" onclick="saveEdit('basicInfoSection')">Save</button>
                                <button class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-1 px-3 rounded-md transition-colors" onclick="cancelEdit('basicInfoSection')">Cancel</button>
                             </div>
                        </div>
                    </div>
                     <!-- View Mode -->
                    <div class="view-mode space-y-2">
                        <p><strong>Full Name:</strong> <span data-field="fullName">Yuliia Smyshliakova</span></p>
                        <p><strong>Gender:</strong> <span data-field="gender">Female</span></p>
                        <p><strong>Date of Birth:</strong> <span data-field="dob">May 15, 1990</span></p>
                        <p><strong>Deceased:</strong> <span data-field="deceased">No</span></p>
                    </div>
                    <!-- Edit Mode -->
                    <div class="edit-mode grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block text-sm font-medium text-gray-600">Full Name</label><input type="text" data-field="fullName" class="mt-1 w-full p-2 border rounded-md" value="Yuliia Smyshliakova"></div>
                        <div><label class="block text-sm font-medium text-gray-600">Gender</label><select data-field="gender" class="mt-1 w-full p-2 border rounded-md"><option>Female</option><option>Male</option><option>Other</option></select></div>
                        <div><label class="block text-sm font-medium text-gray-600">Date of Birth</label><input type="date" data-field="dob" class="mt-1 w-full p-2 border rounded-md" value="1990-05-15"></div>
                         <div><label class="block text-sm font-medium text-gray-600">Date of Death</label><input type="date" data-field="dod" class="mt-1 w-full p-2 border rounded-md"></div>
                        <div class="md:col-span-2 flex items-center"><input type="checkbox" data-field="deceased" id="deceased-checkbox" class="h-4 w-4 rounded mr-2"><label for="deceased-checkbox">Deceased</label></div>
                    </div>
                </section>

                <!-- Life Timeline -->
                <section>
                    <div class="flex justify-between items-center pb-2 border-b mb-4">
                        <h2 class="text-2xl font-semibold">Life Timeline</h2>
                        <button class="bg-button-primary hover:bg-button-primary-hover text-white font-semibold py-1 px-3 rounded-md flex items-center" onclick="openAddMilestoneModal()"><i class="fas fa-plus mr-2"></i>Add Milestone</button>
                    </div>
                    <!-- Timeline: refined style -->
                    <div class="relative pl-8 pr-2">
                        <div class="absolute left-4 top-0 bottom-0 w-1 bg-gradient-to-b from-app-accent via-app-secondary/50 to-app-secondary/10 rounded-full"></div>
                        <ul id="timelineList" class="space-y-8">
                            <!-- Timeline items will be rendered here by JavaScript -->
                        </ul>
                    </div>
                </section>

                <!-- Notes & Stories -->
                <section id="notesSection" class="details-section">
                     <div class="flex justify-between items-center pb-2 border-b mb-4">
                        <h2 class="text-2xl font-semibold">Notes & Stories</h2>
                         <div>
                             <button class="view-mode text-app-primary hover:text-link-hover" onclick="enterEditMode('notesSection')"><i class="fas fa-pencil-alt"></i> Edit</button>
                             <div class="edit-mode space-x-2">
                                <button class="bg-button-primary hover:bg-button-primary-hover text-white font-semibold py-1 px-3 rounded-md transition-colors" onclick="saveEdit('notesSection')">Save</button>
                                <button class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-1 px-3 rounded-md transition-colors" onclick="cancelEdit('notesSection')">Cancel</button>
                             </div>
                        </div>
                    </div>
                    <div class="view-mode text-gray-700 leading-relaxed"><p data-field="notes">Yuliia is passionate about genealogy and loves collecting family stories. This could include personal anecdotes, memories, and stories about Yuliia. This space is for capturing the essence of a person beyond just dates and facts.</p></div>
                    <div class="edit-mode"><textarea data-field="notes" class="w-full p-2 border rounded-md" rows="5">Yuliia is passionate about genealogy and loves collecting family stories. This could include personal anecdotes, memories, and stories about Yuliia. This space is for capturing the essence of a person beyond just dates and facts.</textarea></div>
                </section>

                <!-- Media Gallery -->
                <section>
                    <div class="flex justify-between items-center pb-2 border-b mb-4">
                        <h2 class="text-2xl font-semibold">Media Gallery</h2>
                        <button class="bg-button-primary hover:bg-button-primary-hover text-white font-semibold py-1 px-3 rounded-md flex items-center" onclick="openModal('addMediaModal')"><i class="fas fa-plus mr-2"></i>Add Media</button>
                    </div>
                    <div id="mediaGallery" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                       <!-- Media items will be rendered here by JavaScript -->
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <!-- Edit Profile Picture Modal -->
    <div id="editProfilePicModal" class="modal">
        <div class="modal-content">
             <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold">Update Profile Picture</h3><button class="text-gray-400 hover:text-red-500 text-2xl" onclick="closeModal('editProfilePicModal')">&times;</button></div>
             <p class="text-sm text-gray-600 mb-4">Upload a new photo to set as the profile picture.</p>
             <input type="file" id="profilePicUpload" accept="image/*" class="w-full p-2 border rounded-md mb-4 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
             <div class="flex justify-end space-x-2">
                 <button class="bg-button-danger hover:bg-button-danger-hover text-white font-semibold py-2 px-4 rounded-md" onclick="removeProfilePicture()">Remove</button>
                 <button class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-md" onclick="closeModal('editProfilePicModal')">Cancel</button>
                 <button class="bg-button-primary hover:bg-button-primary-hover text-white font-semibold py-2 px-4 rounded-md" onclick="uploadProfilePicture()">Upload</button>
             </div>
        </div>
    </div>
    <!-- Add/Edit Fact Modal -->
    <div id="addFactModal" class="modal">
    <div class="modal-content">
        <h3 id="factModalTitle" class="text-xl font-semibold mb-4">Add Key Fact</h3>
        <input type="hidden" id="factId">
        <div class="space-y-3">
            <div><label class="text-sm">Label</label><input type="text" id="factLabel" class="w-full p-2 border rounded mt-1" placeholder="e.g., Occupation"></div>
            <div><label class="text-sm">Value</label><input type="text" id="factValue" class="w-full p-2 border rounded mt-1" placeholder="e.g., Software Engineer"></div>
        </div>
        <div class="flex justify-end space-x-2 mt-6">
            <button class="bg-gray-300 font-semibold py-2 px-4 rounded-md" onclick="closeModal('addFactModal')">Cancel</button>
            <button class="bg-button-primary text-white font-semibold py-2 px-4 rounded-md" onclick="saveFact()">Save Fact</button>
        </div>
    </div>
</div>
    <!-- Add/Edit Milestone Modal -->
    <div id="addMilestoneModal" class="modal">
        <div class="modal-content">
             <h3 id="milestoneModalTitle" class="text-xl font-semibold mb-4">Add Life Milestone</h3>
             <input type="hidden" id="milestoneId">
             <div class="space-y-3">
                <div><label class="text-sm">Title</label><input type="text" id="milestoneTitle" class="w-full p-2 border rounded mt-1" placeholder="e.g., Graduated University"></div>
                <div><label class="text-sm">Date</label><input type="date" id="milestoneDate" class="w-full p-2 border rounded mt-1"></div>
                <div><label class="text-sm">Place (Optional)</label><input type="text" id="milestonePlace" class="w-full p-2 border rounded mt-1" placeholder="e.g., Kyiv, Ukraine"></div>
                <div><label class="text-sm">Icon</label>
                    <div id="icon-picker" class="grid grid-cols-6 gap-2 mt-1">
                        <!-- Icons will be rendered here -->
                    </div>
                </div>
            </div>
            <div class="flex justify-end space-x-2 mt-6">
                <button class="bg-gray-300 font-semibold py-2 px-4 rounded-md" onclick="closeModal('addMilestoneModal')">Cancel</button>
                <button class="bg-button-primary text-white font-semibold py-2 px-4 rounded-md" onclick="saveMilestone()">Save Milestone</button>
            </div>
        </div>
    </div>
    <!-- Add Media Modal -->
    <div id="addMediaModal" class="modal">
        <div class="modal-content">
         <h3 class="text-xl font-semibold mb-4">Add Media</h3>
         <p class="text-sm text-app-secondary mb-2">
            Images (JPG, PNG, GIF) or PDF, max 10MB each. Recommended image size: up to 4000×4000px.
         </p>
         <input type="file" id="mediaUpload" accept="image/*,application/pdf" class="w-full p-2 border rounded-md mb-2 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
         <img id="mediaPreview" src="" class="hidden max-h-40 mx-auto rounded-md mb-2">
         <input type="text" id="mediaCaption" class="w-full p-2 border rounded mt-1" placeholder="Optional caption...">
        <div class="flex justify-end space-x-2 mt-6">
            <button class="bg-gray-300 font-semibold py-2 px-4 rounded-md" onclick="closeModal('addMediaModal')">Cancel</button>
            <button class="bg-button-primary text-white font-semibold py-2 px-4 rounded-md" onclick="saveMedia()">Add Media</button>
        </div>
    </div>
    </div>
     <!-- Share Profile Modal -->
    <div id="shareProfileModal" class="modal">
        <div class="modal-content">
         <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Share Profile</h3>
            <button class="text-gray-400 hover:text-red-500 text-2xl" onclick="closeModal('shareProfileModal')" aria-label="Close modal">&times;</button>
         </div>
         <div class="bg-gray-100 p-4 rounded-lg text-center mb-4">
            <i class="fas fa-user-circle text-6xl text-gray-300"></i>
            <p class="mt-2 font-semibold">Snapshot of Yuliia's Profile</p>
         </div>
         <textarea id="shareProfileCaption" class="w-full p-2 border rounded-md" placeholder="Add an optional caption..."></textarea>
        <div class="flex justify-center space-x-4 mt-4">
            <button class="text-2xl text-blue-600 hover:text-blue-800" title="Share on Facebook" onclick="shareOnFacebook('profile')"><i class="fab fa-facebook-square"></i></button>
            <button class="text-2xl text-black hover:text-gray-700" title="Share on X" onclick="shareOnX('profile')"><i class="fab fa-x-twitter"></i></button>
            <button class="text-2xl text-green-500 hover:text-green-700" title="Share on WhatsApp" onclick="shareOnWhatsApp('profile')"><i class="fab fa-whatsapp-square"></i></button>
            <button class="text-2xl text-red-500 hover:text-red-700" title="Share via Email" onclick="shareViaEmail('profile')"><i class="fas fa-envelope-square"></i></button>
            <button class="text-2xl text-gray-600 hover:text-gray-800" onclick="copyShareLink()" title="Copy Link"><i class="fas fa-link"></i></button>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer"></div>

    <script>
    // --- Mock Data & State Management ---
    // In a real app, this data would come from an API.
    const profileData = {
        id: 1,
        fullName: "Yuliia Smyshliakova",
        gender: "Female",
        dob: "1990-05-15",
        dod: null,
        isDeceased: false,
        profilePicture: "https://randomuser.me/api/portraits/women/44.jpg",
        notes: "Yuliia is passionate about genealogy and loves collecting family stories. This could include personal anecdotes, memories, and stories about Yuliia. This space is for capturing the essence of a person beyond just dates and facts.",
        keyFacts: [
            { id: 1, label: "Occupation", value: "Software Engineer" },
            { id: 2, label: "Nationality", value: "Ukrainian" },
        ],
        timeline: [
            { id: 1, title: "Born", date: "1990-05-15", place: "Kyiv, Ukraine", icon: "fas fa-birthday-cake" },
            { id: 2, title: "Studied Computer Science", date: "2012-06-20", place: "Kyiv Polytechnic", icon: "fas fa-graduation-cap" },
            { id: 3, title: "Moved to Dublin", date: "2021-08-01", place: "Dublin, Ireland", icon: "fas fa-plane-departure" },
        ],
        media: [
            { id: 1, type: 'image', url: 'https://images.unsplash.com/photo-1544005313-94ddf0286df2?q=80&w=200&h=200&auto=format&fit=crop', caption: 'Early photo' },
            { id: 2, type: 'image', url: 'https://images.unsplash.com/photo-1554151228-14d9def656e4?q=80&w=200&h=200&auto=format&fit=crop', caption: 'Vacation' },
        ]
    };
    const originalState = {};
    const ICONS = ['fas fa-birthday-cake', 'fas fa-graduation-cap', 'fas fa-briefcase', 'fas fa-heart', 'fas fa-home', 'fas fa-plane-departure', 'fas fa-car', 'fas fa-camera', 'fas fa-flag', 'fas fa-medal', 'fas fa-star', 'fas fa-church', 'fas fa-users', 'fas fa-ring', 'fas fa-ship'];
    
    // --- Utility Functions ---
    const showToast = (message, type = 'info', duration = 3000) => {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => toast.classList.add('show'), 100);
        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, duration);
    };

    const openModal = (modalId) => {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('is-open');
            document.body.style.overflow = 'hidden';
        }
        if (modalId === 'addFactModal') {
            const factId = document.getElementById('factId');
            if (!factId.value) {
                document.getElementById('factModalTitle').textContent = 'Add Key Fact';
            }
        }
    };

    const closeModal = (modalId) => {
        const modal = document.getElementById(modalId);
        if (modal) {
            // Reset forms within the modal
            const form = modal.querySelector('div.modal-content');
            if (form) form.querySelectorAll('input, select, textarea').forEach(el => {
                if (el.type !== 'checkbox') el.value = '';
                else el.checked = false;
            });
            // Hide preview images
            const preview = document.getElementById('mediaPreview');
            if(preview) preview.classList.add('hidden');

            modal.classList.remove('is-open');
            document.body.style.overflow = '';
        }
    };
    
    // --- Rendering Functions ---
    const renderAll = () => {
        // Basic Info
        document.getElementById('profileName').textContent = profileData.fullName;
        document.getElementById('profileImage').src = profileData.profilePicture;
        const age = profileData.isDeceased ? '' : `${new Date().getFullYear() - new Date(profileData.dob).getFullYear()} y.o.`;
        document.getElementById('profileAge').innerHTML = `${age} <i class="fas ${profileData.gender === 'Female' ? 'fa-venus text-pink-500' : 'fa-mars text-blue-500'}"></i>`;
        
        // Key Facts
        const keyFactsList = document.getElementById('keyFactsList');
        keyFactsList.innerHTML = profileData.keyFacts.map(fact => `
            <li class="flex justify-between items-center group">
                <span><strong>${fact.label}:</strong> ${fact.value}</span>
                <span class="opacity-0 group-hover:opacity-100 transition-opacity">
                    <button class="text-sm text-app-primary hover:text-link" onclick="editFact(${fact.id})"><i class="fas fa-pencil-alt"></i></button>
                    <button class="text-sm text-red-500 hover:text-red-700" onclick="deleteFact(${fact.id})"><i class="fas fa-trash-alt"></i></button>
                </span>
            </li>
        `).join('');
        
        // --- Life Timeline: refined item style ---
        const timelineList = document.getElementById('timelineList');
        timelineList.innerHTML = profileData.timeline
            .sort((a, b) => new Date(a.date) - new Date(b.date))
            .map((item, idx, arr) => `
            <li class="relative group flex items-start">
                <!-- Timeline Dot/Icon -->
                <div class="absolute -left-[39px] top-2 z-10">
                    <span class="
                        flex items-center justify-center
                        w-10 h-10 rounded-full 
                        shadow
                        bg-app-accent text-white
                        border-4 border-app-container
                        transition-transform duration-300
                        group-hover:scale-105
                    ">
                        <i class="${item.icon} fa-lg"></i>
                    </span>
                </div>
                ${
                    idx !== arr.length - 1
                    ? `<div class="absolute left-1.5 top-12 w-1 h-[calc(100%-2.5rem)] bg-app-accent/40 rounded-full"></div>`
                    : ''
                }
                <!-- Timeline Content Card -->
                <div class="ml-4 flex-1 bg-white/80 rounded-lg shadow-sm px-6 py-4 border border-app-accent/10 transition group-hover:shadow-lg">
                    <div class="flex justify-between items-center">
                        <div>
                            <h4 class="font-semibold text-app-primary text-lg tracking-tight mb-1">${item.title}</h4>
                            <p class="text-sm text-app-secondary mb-1">
                                <span class="font-medium text-app-primary">${new Date(item.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}</span>
                                ${item.place ? ` &mdash; <span class="italic">${item.place}</span>` : ''}
                            </p>
                        </div>
                        <span class="opacity-0 group-hover:opacity-100 transition-opacity flex gap-2">
                            <button class="text-app-primary hover:text-link" onclick="editMilestone(${item.id})" title="Edit"><i class="fas fa-pencil-alt"></i></button>
                            <button class="text-red-500 hover:text-red-700" onclick="deleteMilestone(${item.id})" title="Delete"><i class="fas fa-trash-alt"></i></button>
                        </span>
                    </div>
                </div>
            </li>
        `).join('');

        // Media Gallery
        const mediaGallery = document.getElementById('mediaGallery');
        mediaGallery.innerHTML = profileData.media.map(item => `
            <div class="relative group aspect-square">
                <img src="${item.url}" alt="${item.caption}" class="w-full h-full object-cover rounded-md shadow-md">
                <div class="absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity rounded-md">
                     <button class="text-white text-xl" onclick="deleteMedia(${item.id})"><i class="fas fa-trash-alt"></i></button>
                </div>
            </div>
        `).join('');
    };
    
    // --- Event Handlers & Page Logic ---
    // Section Editing
    function enterEditMode(sectionId) {
        const section = document.getElementById(sectionId);
        section.classList.add('editing');
        originalState[sectionId] = {};
        section.querySelectorAll('[data-field]').forEach(el => {
             originalState[sectionId][el.dataset.field] = el.matches('input[type=checkbox]') ? el.checked : (el.value || el.textContent);
        });
    }

    function saveEdit(sectionId) {
        const section = document.getElementById(sectionId);
        section.querySelectorAll('[data-field]').forEach(el => {
            const field = el.dataset.field;
            const value = el.matches('input[type=checkbox]') ? el.checked : el.value;
            profileData[field] = value;
            if (section.querySelector(`.view-mode [data-field="${field}"]`)) {
                 section.querySelector(`.view-mode [data-field="${field}"]`).textContent = field === 'deceased' ? (value ? 'Yes' : 'No') : value;
            }
        });
        section.classList.remove('editing');
        showToast('Section updated!', 'success');
        renderAll();
    }
    
    function cancelEdit(sectionId) {
        const section = document.getElementById(sectionId);
        section.querySelectorAll('[data-field]').forEach(el => {
            if(el.matches('input[type=checkbox]')) el.checked = originalState[sectionId][el.dataset.field];
            else el.value = originalState[sectionId][el.dataset.field];
        });
        section.classList.remove('editing');
    }

    // Key Facts Logic
    const editFact = (id) => {
        const fact = profileData.keyFacts.find(f => f.id === id);
        document.getElementById('factId').value = fact.id;
        document.getElementById('factLabel').value = fact.label;
        document.getElementById('factValue').value = fact.value;
        document.getElementById('factModalTitle').textContent = 'Edit Key Fact';
        openModal('addFactModal');
    };

    const deleteFact = (id) => {
        if (confirm('Are you sure you want to delete this fact?')) {
            profileData.keyFacts = profileData.keyFacts.filter(f => f.id !== id);
            showToast('Fact deleted.', 'success');
            renderAll();
        }
    };
    
    const saveFact = () => {
        const id = parseInt(document.getElementById('factId').value);
        const label = document.getElementById('factLabel').value;
        const value = document.getElementById('factValue').value;
        if (!label || !value) {
            showToast('Label and value cannot be empty.', 'error');
            return;
        }
        if (id) {
            const fact = profileData.keyFacts.find(f => f.id === id);
            fact.label = label;
            fact.value = value;
        } else {
            profileData.keyFacts.push({ id: Date.now(), label, value });
        }
        showToast('Fact saved!', 'success');
        closeModal('addFactModal');
        renderAll();
    };
    
    // Milestone Logic
    const openAddMilestoneModal = () => {
        // Set title for "Add" mode and ensure form is clear
        document.getElementById('milestoneModalTitle').textContent = 'Add Life Milestone';
        document.getElementById('milestoneId').value = '';
        document.getElementById('milestoneTitle').value = '';
        document.getElementById('milestoneDate').value = '';
        document.getElementById('milestonePlace').value = '';
        document.querySelectorAll('#icon-picker .icon-option').forEach(opt => opt.classList.remove('selected'));
        openModal('addMilestoneModal');
    };

    const editMilestone = (id) => {
        const item = profileData.timeline.find(i => i.id === id);
        document.getElementById('milestoneId').value = item.id;
        document.getElementById('milestoneTitle').value = item.title;
        document.getElementById('milestoneDate').value = item.date;
        document.getElementById('milestonePlace').value = item.place;
        document.querySelectorAll('#icon-picker .icon-option').forEach(opt => {
            opt.classList.toggle('selected', opt.dataset.icon === item.icon);
        });
        document.getElementById('milestoneModalTitle').textContent = 'Edit Life Milestone';
        openModal('addMilestoneModal');
    };

    const deleteMilestone = (id) => {
        if (confirm('Are you sure you want to delete this milestone?')) {
            profileData.timeline = profileData.timeline.filter(i => i.id !== id);
            showToast('Milestone deleted.', 'success');
            renderAll();
        }
    };

    const saveMilestone = () => {
        const id = parseInt(document.getElementById('milestoneId').value);
        const title = document.getElementById('milestoneTitle').value;
        const date = document.getElementById('milestoneDate').value;
        const place = document.getElementById('milestonePlace').value;
        const selectedIcon = document.querySelector('#icon-picker .selected');
        
        if (!title || !date || !selectedIcon) {
            showToast('Title, date, and icon are required.', 'error');
            return;
        }
        const icon = selectedIcon.dataset.icon;
        
        if (id) {
            const item = profileData.timeline.find(i => i.id === id);
            item.title = title; item.date = date; item.place = place; item.icon = icon;
        } else {
            profileData.timeline.push({ id: Date.now(), title, date, place, icon });
        }
        showToast('Milestone saved!', 'success');
        closeModal('addMilestoneModal');
        renderAll();
    };

    // Media Logic
    const deleteMedia = (id) => {
        if (confirm('Are you sure you want to delete this media item?')) {
            profileData.media = profileData.media.filter(m => m.id !== id);
            showToast('Media deleted.', 'success');
            renderAll();
        }
    };
    
    const saveMedia = () => {
        const fileInput = document.getElementById('mediaUpload');
        const caption = document.getElementById('mediaCaption').value;
        if (fileInput.files.length === 0) {
            showToast('Please select a file to upload.', 'error');
            return;
        }
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            profileData.media.push({
                id: Date.now(),
                type: 'image',
                url: e.target.result,
                caption: caption
            });
            showToast('Media added!', 'success');
            closeModal('addMediaModal');
            renderAll();
        };
        reader.readAsDataURL(file);
    };

    // Profile Picture Logic
    const uploadProfilePicture = () => {
        const uploader = document.getElementById('profilePicUpload');
        if(uploader.files.length > 0){
            const reader = new FileReader();
            reader.onload = function(e){
                profileData.profilePicture = e.target.result;
                renderAll();
                showToast('Profile picture updated!', 'success');
                closeModal('editProfilePicModal');
            }
            reader.readAsDataURL(uploader.files[0]);
        } else {
            showToast('Please select an image file first.', 'error');
        }
    };

    const removeProfilePicture = () => {
        profileData.profilePicture = 'https://placehold.co/200x200/F8F4F0/4A4A4A?text=No+Image';
        renderAll();
        showToast('Profile picture removed.', 'info');
        closeModal('editProfilePicModal');
    };

    // Share Logic
    const getShareText = (type) => {
        const caption = type === 'profile' ? document.getElementById('shareProfileCaption').value : document.getElementById('shareTreeCaption').value;
        const defaultText = type === 'profile' ? `Check out ${profileData.fullName}'s profile on ChronicleTree!` : 'Check out my family tree on ChronicleTree!';
        return caption || defaultText;
    };

    const shareOnFacebook = (type) => {
        const text = encodeURIComponent(getShareText(type));
        const url = encodeURIComponent(window.location.href);
        window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${text}`, '_blank');
    };

    const shareOnX = (type) => {
        const text = encodeURIComponent(getShareText(type));
        const url = encodeURIComponent(window.location.href);
        window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
    };

    const shareOnWhatsApp = (type) => {
        const text = encodeURIComponent(getShareText(type));
        const url = encodeURIComponent(window.location.href);
        window.open(`https://wa.me/?text=${text}%20${url}`, '_blank');
    };

    const shareViaEmail = (type) => {
        const subject = encodeURIComponent(type === 'profile' ? `ChronicleTree Profile: ${profileData.fullName}` : 'My Family Tree on ChronicleTree');
        const body = encodeURIComponent(`${getShareText(type)}\n\nView it here: ${window.location.href}`);
        window.location.href = `mailto:?subject=${subject}&body=${body}`;
    };

    const copyShareLink = () => {
        navigator.clipboard.writeText(window.location.href).then(() => {
            showToast('Link copied to clipboard!', 'success');
        }, () => {
            showToast('Failed to copy link.', 'error');
        });
    };
    
    // --- Initial Setup ---
    document.addEventListener('DOMContentLoaded', () => {
        // Logout button
        document.getElementById('logoutBtn').addEventListener('click', () => {
            showToast('Logging out...', 'info');
            setTimeout(() => window.location.href = 'chronicle_login.html', 1000);
        });

        // Mobile menu toggle
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobileMenu = document.getElementById('mobileMenu');
        if (mobileMenuBtn && mobileMenu) {
            mobileMenuBtn.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });
        }

        // Populate Icon Picker
        const iconPicker = document.getElementById('icon-picker');
        iconPicker.innerHTML = ICONS.map(icon => `<span class="icon-option text-center" data-icon="${icon}"><i class="${icon} fa-2x"></i></span>`).join('');
        iconPicker.addEventListener('click', (e) => {
            const target = e.target.closest('.icon-option');
            if (target) {
                iconPicker.querySelectorAll('.icon-option').forEach(opt => opt.classList.remove('selected'));
                target.classList.add('selected');
            }
        });

        // Media preview
        document.getElementById('mediaUpload').addEventListener('change', (e) => {
            const preview = document.getElementById('mediaPreview');
            if(e.target.files && e.target.files[0]){
                 const reader = new FileReader();
                 reader.onload = (ev) => {
                     preview.src = ev.target.result;
                     preview.classList.remove('hidden');
                 }
                 reader.readAsDataURL(e.target.files[0]);
            }
        });

        // Initial render
        renderAll();
    });
    </script>
</body>
</html>